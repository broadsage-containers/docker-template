# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage Corporation <containers@broadsage.com>
#
# SPDX-License-Identifier: Apache-2.0

# {{ organization }}/{{ project.name }}
# Multi-stage build for {{ project.name }} container

# Build arguments
ARG BUILD_DATE
ARG VERSION
ARG {{ project.name | upper }}_VERSION="latest"

# Use Alpine Linux as base for security and size
FROM alpine:3.20 AS base

# Add metadata labels following OCI spec
LABEL org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.title="{{ project.name }}" \
      org.opencontainers.image.description="{{ project.description }}" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.authors="{{ maintainer.email }}" \
      org.opencontainers.image.url="{{ project_url }}" \
      org.opencontainers.image.source="{{ project_url }}" \
      org.opencontainers.image.vendor="{{ organization }}" \
      org.opencontainers.image.licenses="{{ license_type }}" 

# Install security updates and required packages
RUN apk update && \
    apk upgrade && \
    apk add --no-cache \
        ca-certificates \
        tzdata \
        su-exec \
        && \
    # Create non-root user for security
    addgroup -g 1000 {{ container_name }} && \
    adduser -D -s /bin/sh -u 1000 -G {{ container_name }} {{ container_name }} && \
    # Create necessary directories
    mkdir -p /app /config /defaults && \
    chown -R {{ container_name }}:{{ container_name }} /app /config /defaults

# Application stage
FROM base AS app

# Install application-specific packages
RUN apk add --no-cache \
    # Add your application packages here
    curl \
    jq

# Copy application files
COPY root/ /

# Set proper permissions
RUN chmod +x /etc/services.d/*/run /etc/cont-init.d/* && \
    chown -R {{ container_name }}:{{ container_name }} /app /config /defaults

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:{{ container_port }}/health || exit 1

# Expose port
EXPOSE {{ container_port }}

# Use non-root user
USER {{ container_name }}

# Set working directory
WORKDIR /app

# Default command
CMD ["/init"]